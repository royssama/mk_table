<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL í…Œì´ë¸” ì¶”ì¶œê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        .input-section label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .result-section {
            margin-top: 30px;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .result-header h2 {
            color: #333;
            font-size: 22px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-item .number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-item .label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        .type-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .type-select {
            background: #667eea;
            color: white;
        }
        
        .type-insert {
            background: #28a745;
            color: white;
        }
        
        .type-update {
            background: #ffc107;
            color: #333;
        }
        
        .type-delete {
            background: #dc3545;
            color: white;
        }
        
        .type-merge {
            background: #17a2b8;
            color: white;
        }
        
        .type-exec {
            background: #6f42c1;
            color: white;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 16px;
        }
        
        .table-name {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #333;
        }
        
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-section select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .filter-section select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-section {
            justify-content: space-between;
        }
        
        table th input[type="checkbox"] {
            margin-left: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” SQL í…Œì´ë¸” ì¶”ì¶œê¸°</h1>
            <p>í”„ë¡œì‹œì € ë˜ëŠ” ì¿¼ë¦¬ë¬¸ì„ ì…ë ¥í•˜ë©´ íƒ€ì…ë³„ í…Œì´ë¸”ì„ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <label for="sqlInput">SQL í”„ë¡œì‹œì € ë˜ëŠ” ì¿¼ë¦¬ë¬¸ ì…ë ¥:</label>
                <textarea id="sqlInput" placeholder="CREATE PROCEDURE ... ë˜ëŠ” SELECT ... FROM ... ë“±ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="extractTables()">í…Œì´ë¸” ì¶”ì¶œ</button>
                    <button class="btn-secondary" onclick="clearAll()">ì „ì²´ ì§€ìš°ê¸°</button>
                </div>
            </div>
            
            <div class="result-section" id="resultSection" style="display: none;">
                <div class="result-header">
                    <h2>ì¶”ì¶œ ê²°ê³¼</h2>
                    <div class="stats" id="stats"></div>
                </div>
                
                <div class="filter-section">
                    <label>íƒ€ì… í•„í„°:</label>
                    <select id="typeFilter" onchange="filterTable()">
                        <option value="all">ì „ì²´</option>
                        <option value="select">SELECT</option>
                        <option value="insert">INSERT</option>
                        <option value="update">UPDATE</option>
                        <option value="delete">DELETE</option>
                        <option value="merge">MERGE</option>
                        <option value="exec">PROCEDURE</option>
                    </select>
                    <button class="btn-primary" onclick="copySelectedColumns()" style="margin-left: auto;">Copy</button>
                </div>
                
                <div id="tableContainer"></div>
            </div>
        </div>
    </div>

    <script>
        var allTables = [];
        var filteredTables = [];
        var cteNames = [];

        function extractTables() {
            var sqlText = document.getElementById('sqlInput').value.trim();
            
            if (!sqlText) {
                alert('SQL ë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            allTables = [];
            cteNames = [];
            
            // SQLì„ ëŒ€ë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ íŒŒì‹± (ì›ë³¸ì€ ìœ ì§€)
            var sqlUpper = sqlText.toUpperCase();
            
            // CTE ì´ë¦„ ì¶”ì¶œ (ì œì™¸ ëª©ë¡)
            extractCTENames(sqlText, sqlUpper);
            
            // SELECT ë¬¸ì—ì„œ í…Œì´ë¸” ì¶”ì¶œ
            extractSelectTables(sqlText, sqlUpper);
            
            // INSERT ë¬¸ì—ì„œ í…Œì´ë¸” ì¶”ì¶œ
            extractInsertTables(sqlText, sqlUpper);
            
            // UPDATE ë¬¸ì—ì„œ í…Œì´ë¸” ì¶”ì¶œ
            extractUpdateTables(sqlText, sqlUpper);
            
            // DELETE ë¬¸ì—ì„œ í…Œì´ë¸” ì¶”ì¶œ
            extractDeleteTables(sqlText, sqlUpper);
            
            // MERGE ë¬¸ì—ì„œ í…Œì´ë¸” ì¶”ì¶œ
            extractMergeTables(sqlText, sqlUpper);
            
            // EXEC/EXECUTE ë¬¸ì—ì„œ í”„ë¡œì‹œì € ì¶”ì¶œ
            extractProcedureCalls(sqlText, sqlUpper);
            
            // ì¤‘ë³µ ì œê±°
            removeDuplicates();
            
            // ê²°ê³¼ í‘œì‹œ
            displayResults();
        }
        
        function extractCTENames(sqlText, sqlUpper) {
            // WITH ì ˆì—ì„œ CTE ì´ë¦„ ì¶”ì¶œ
            var withPattern = /WITH\s+([A-Za-z_][A-Za-z0-9_]*)\s+AS/gi;
            var match;
            
            while ((match = withPattern.exec(sqlText)) !== null) {
                var cteName = match[1].trim();
                if (cteName) {
                    cteNames.push(cteName.toUpperCase());
                }
            }
            
            // ì—¬ëŸ¬ CTEê°€ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ê²½ìš°
            var multiCTEPattern = /,\s*([A-Za-z_][A-Za-z0-9_]*)\s+AS/gi;
            while ((match = multiCTEPattern.exec(sqlText)) !== null) {
                var cteName = match[1].trim();
                if (cteName) {
                    cteNames.push(cteName.toUpperCase());
                }
            }
        }
        
        function extractSelectTables(sqlText, sqlUpper) {
            // FROM ì ˆ ì „ì²´ë¥¼ ì°¾ì•„ì„œ ì²˜ë¦¬
            var fromPattern = /FROM\s+/gi;
            var match;
            
            while ((match = fromPattern.exec(sqlText)) !== null) {
                var fromStart = match.index + match[0].length;
                
                // FROM ì ˆì˜ ëì„ ì°¾ê¸°
                // ON ì ˆì€ MERGE ë¬¸ì˜ ì¡°ì¸ ì¡°ê±´ì´ë¯€ë¡œ FROM ì ˆì´ ì•„ë‹˜
                var onPos = sqlText.indexOf(' ON ', fromStart);
                var fromEnd = sqlText.indexOf('WHERE', fromStart);
                if (fromEnd === -1 || (onPos !== -1 && onPos < fromEnd)) {
                    fromEnd = onPos !== -1 ? onPos : fromEnd;
                }
                if (fromEnd === -1) {
                    fromEnd = sqlText.indexOf('GROUP', fromStart);
                }
                if (fromEnd === -1) {
                    fromEnd = sqlText.indexOf('ORDER', fromStart);
                }
                if (fromEnd === -1) {
                    fromEnd = sqlText.indexOf('INNER', fromStart);
                }
                if (fromEnd === -1) {
                    fromEnd = sqlText.indexOf('LEFT', fromStart);
                }
                if (fromEnd === -1) {
                    fromEnd = sqlText.indexOf('RIGHT', fromStart);
                }
                if (fromEnd === -1) {
                    fromEnd = sqlText.indexOf('FULL', fromStart);
                }
                if (fromEnd === -1) {
                    fromEnd = sqlText.indexOf('UNION', fromStart);
                }
                if (fromEnd === -1) {
                    fromEnd = sqlText.indexOf(';', fromStart);
                }
                if (fromEnd === -1) {
                    fromEnd = fromStart + 1000; // ìµœëŒ€ 1000ìê¹Œì§€
                }
                
                var fromClause = sqlText.substring(fromStart, fromEnd);
                
                // FROM ì ˆì—ì„œ ëª¨ë“  í…Œì´ë¸” ì¶”ì¶œ (ì„œë¸Œì¿¼ë¦¬ ì œì™¸)
                // íŒ¨í„´ 1: schema.table alias ë˜ëŠ” table alias (ì½¤ë§ˆ ì—†ì´ ì‹œì‘)
                // íŒ¨í„´ 2: , schema.table alias ë˜ëŠ” , table alias (ì½¤ë§ˆë¡œ ì‹œì‘)
                // ì„œë¸Œì¿¼ë¦¬ (SELECTë¡œ ì‹œì‘í•˜ëŠ” ê´„í˜¸)ëŠ” ê±´ë„ˆë›°ê¸°
                
                var pos = 0;
                while (pos < fromClause.length) {
                    // ê³µë°± ê±´ë„ˆë›°ê¸°
                    while (pos < fromClause.length && /\s/.test(fromClause[pos])) {
                        pos++;
                    }
                    if (pos >= fromClause.length) break;
                    
                    // ì½¤ë§ˆ ê±´ë„ˆë›°ê¸°
                    if (fromClause[pos] === ',') {
                        pos++;
                        while (pos < fromClause.length && /\s/.test(fromClause[pos])) {
                            pos++;
                        }
                    }
                    
                    // ì„œë¸Œì¿¼ë¦¬ì¸ì§€ í™•ì¸ (SELECTë¡œ ì‹œì‘í•˜ëŠ” ê´„í˜¸)
                    var remaining = fromClause.substring(pos);
                    if (/^\s*\(/i.test(remaining)) {
                        // ê´„í˜¸ë¡œ ì‹œì‘í•˜ë©´ ì„œë¸Œì¿¼ë¦¬ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
                        // ê´„í˜¸ ë§¤ì¹­í•˜ì—¬ ì„œë¸Œì¿¼ë¦¬ ë‚´ë¶€ì˜ FROM ì ˆë„ ì¶”ì¶œ
                        var parenCount = 0;
                        var subqueryStart = pos;
                        var foundSelect = false;
                        var subqueryContent = '';
                        for (var i = pos; i < fromClause.length; i++) {
                            if (fromClause[i] === '(') {
                                parenCount++;
                                // ê´„í˜¸ ë‹¤ìŒì— SELECTê°€ ìˆëŠ”ì§€ í™•ì¸
                                var afterParen = fromClause.substring(i + 1).trim();
                                if (/^SELECT/i.test(afterParen)) {
                                    foundSelect = true;
                                }
                            } else if (fromClause[i] === ')') {
                                parenCount--;
                                if (parenCount === 0 && foundSelect) {
                                    // ì„œë¸Œì¿¼ë¦¬ ë‚´ìš© ì¶”ì¶œ (ê´„í˜¸ ì œì™¸)
                                    subqueryContent = fromClause.substring(subqueryStart + 1, i);
                                    // ì„œë¸Œì¿¼ë¦¬ ë‚´ë¶€ì˜ FROM ì ˆì—ì„œ í…Œì´ë¸” ì¶”ì¶œ
                                    extractTablesFromSubquery(subqueryContent);
                                    
                                    // ì„œë¸Œì¿¼ë¦¬ ë, ë³„ì¹­ê¹Œì§€ ê±´ë„ˆë›°ê¸°
                                    var afterSubquery = fromClause.substring(i + 1).trim();
                                    var aliasMatch = afterSubquery.match(/^[A-Za-z_][A-Za-z0-9_]*/);
                                    if (aliasMatch) {
                                        pos = i + 1 + aliasMatch[0].length;
                                    } else {
                                        pos = i + 1;
                                    }
                                    break;
                                }
                            }
                        }
                        if (parenCount !== 0 || !foundSelect) {
                            // ê´„í˜¸ê°€ ë§ì§€ ì•Šê±°ë‚˜ ì„œë¸Œì¿¼ë¦¬ê°€ ì•„ë‹ˆë©´ ì¼ë°˜ í…Œì´ë¸”ë¡œ ì²˜ë¦¬
                            pos++;
                        }
                        continue;
                    }
                    
                    // í…Œì´ë¸”ëª… íŒ¨í„´ ì°¾ê¸° (ìŠ¤í‚¤ë§ˆëª… í¬í•¨)
                    // schema.table alias ë˜ëŠ” table alias
                    var tablePattern = /^((?:\[?[A-Za-z_][A-Za-z0-9_]*\]?\.)?\[?#?[A-Za-z_][A-Za-z0-9_]*\]?)\s+([A-Za-z_][A-Za-z0-9_]*)/i;
                    var tableMatch = fromClause.substring(pos).match(tablePattern);
                    if (tableMatch) {
                        var fullTableRef = tableMatch[1].trim();
                        var tableName = extractTableNameFromRef(fullTableRef);
                        if (tableName && !isKeyword(tableName) && !isCTEName(tableName)) {
                            allTables.push({
                                type: 'select',
                                name: tableName
                            });
                        }
                        // ë³„ì¹­ê¹Œì§€ ê±´ë„ˆë›°ê¸°
                        pos += tableMatch[0].length;
                    } else {
                        // íŒ¨í„´ì´ ë§ì§€ ì•Šìœ¼ë©´ ë‹¤ìŒ ë¬¸ìë¡œ
                        pos++;
                    }
                }
            }
            
            // JOIN íŒ¨í„´ ì°¾ê¸° (CTE ì œì™¸, ìŠ¤í‚¤ë§ˆëª… í¬í•¨ ì§€ì›)
            var joinPattern = /(?:INNER|LEFT|RIGHT|FULL|OUTER)?\s*JOIN\s+((?:\[?[A-Za-z_][A-Za-z0-9_]*\]?\.)?\[?#?[A-Za-z_][A-Za-z0-9_]*\]?)/gi;
            while ((match = joinPattern.exec(sqlText)) !== null) {
                var joinFullRef = match[1].trim();
                var tableName = extractTableNameFromRef(joinFullRef);
                if (tableName && !isKeyword(tableName) && !isCTEName(tableName)) {
                    allTables.push({
                        type: 'select',
                        name: tableName
                    });
                }
            }
        }
        
        // ì„œë¸Œì¿¼ë¦¬ ë‚´ë¶€ì˜ FROM ì ˆì—ì„œ í…Œì´ë¸” ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function extractTablesFromSubquery(subqueryText) {
            // ì„œë¸Œì¿¼ë¦¬ ë‚´ë¶€ì˜ FROM ì ˆ ì°¾ê¸°
            var fromPattern = /FROM\s+((?:\[?[A-Za-z_][A-Za-z0-9_]*\]?\.)?\[?#?[A-Za-z_][A-Za-z0-9_]*\]?)/gi;
            var match;
            
            while ((match = fromPattern.exec(subqueryText)) !== null) {
                var fullTableRef = match[1].trim();
                var tableName = extractTableNameFromRef(fullTableRef);
                
                if (tableName && !isKeyword(tableName) && !isCTEName(tableName)) {
                    allTables.push({
                        type: 'select',
                        name: tableName
                    });
                }
            }
        }
        
        // ìŠ¤í‚¤ë§ˆëª… í¬í•¨ í…Œì´ë¸” ì°¸ì¡°ì—ì„œ í…Œì´ë¸”ëª…ë§Œ ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        // schema.table -> table
        // [schema].[table] -> table
        // table -> table
        function extractTableNameFromRef(fullRef) {
            if (!fullRef) return '';
            
            // ëŒ€ê´„í˜¸ ì œê±°
            fullRef = fullRef.replace(/[\[\]]/g, '');
            
            // ì (.)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ë§ˆì§€ë§‰ ë¶€ë¶„ì´ í…Œì´ë¸”ëª…
            var parts = fullRef.split('.');
            if (parts.length > 1) {
                // ìŠ¤í‚¤ë§ˆëª….table í˜•ì‹
                return parts[parts.length - 1].trim();
            } else {
                // table í˜•ì‹
                return parts[0].trim();
            }
        }
        
        function extractInsertTables(sqlText, sqlUpper) {
            // INSERT INTO í…Œì´ë¸”ëª… íŒ¨í„´
            var insertPattern = /INSERT\s+(?:INTO\s+)?([#]?[A-Za-z_][A-Za-z0-9_]*)/gi;
            var match;
            
            while ((match = insertPattern.exec(sqlText)) !== null) {
                var tableName = match[1].trim();
                if (tableName && !isKeyword(tableName)) {
                    allTables.push({
                        type: 'insert',
                        name: tableName
                    });
                }
            }
        }
        
        function extractUpdateTables(sqlText, sqlUpper) {
            // UPDATE ë¬¸ì„ ì°¾ì•„ì„œ ë¸”ë¡ ë‹¨ìœ„ë¡œ ì²˜ë¦¬
            // MERGE ë¬¸ ë‚´ë¶€ì˜ "update set"ì€ ì œì™¸ (WHEN MATCHED THEN UPDATE SET)
            var updateRegex = /UPDATE\s+([#]?[A-Za-z_][A-Za-z0-9_]*)\s+SET/gi;
            var updateMatch;
            
            while ((updateMatch = updateRegex.exec(sqlText)) !== null) {
                var updateStart = updateMatch.index;
                var alias = updateMatch[1].trim();
                
                // MERGE ë¬¸ ë‚´ë¶€ì˜ UPDATEì¸ì§€ í™•ì¸
                // UPDATE ì•ì— "THEN"ì´ ìˆìœ¼ë©´ MERGE ë¬¸ ë‚´ë¶€ì˜ UPDATE
                var beforeUpdate = sqlText.substring(Math.max(0, updateStart - 50), updateStart).toUpperCase();
                if (beforeUpdate.indexOf('THEN') !== -1) {
                    // MERGE ë¬¸ ë‚´ë¶€ì˜ UPDATEëŠ” ê±´ë„ˆë›°ê¸°
                    continue;
                }
                
                // "update" í‚¤ì›Œë“œ ìì²´ëŠ” ì œì™¸
                if (alias.toUpperCase() === 'UPDATE') {
                    continue;
                }
                
                // UPDATE ë¸”ë¡ì˜ ëì„ ì°¾ê¸° (ë‹¤ìŒ ë¬¸ì¥ ì¢…ë£Œê¹Œì§€)
                var blockEnd = sqlText.indexOf(';', updateStart);
                if (blockEnd === -1) {
                    blockEnd = sqlText.length;
                }
                var updateBlock = sqlText.substring(updateStart, blockEnd);
                
                // SET ë‹¤ìŒì— ë‚˜ì˜¤ëŠ” FROM ì ˆ ì°¾ê¸° (ê´„í˜¸ ë°–ì˜ FROMë§Œ)
                // UPDATE ë¸”ë¡ì—ì„œ ëª¨ë“  FROM ìœ„ì¹˜ ì°¾ê¸°
                var fromMatches = [];
                var fromRegex = /FROM\s+([#]?[A-Za-z_][A-Za-z0-9_]*)/gi;
                var tempMatch;
                
                while ((tempMatch = fromRegex.exec(updateBlock)) !== null) {
                    var fromPos = tempMatch.index;
                    var tableName = tempMatch[1].trim();
                    
                    // SETê³¼ FROM ì‚¬ì´ì˜ í…ìŠ¤íŠ¸
                    var setPos = updateBlock.indexOf('SET');
                    if (setPos < fromPos) {
                        var setToFrom = updateBlock.substring(setPos, fromPos);
                        // ê´„í˜¸ ê°œìˆ˜ í™•ì¸
                        var openParens = (setToFrom.match(/\(/g) || []).length;
                        var closeParens = (setToFrom.match(/\)/g) || []).length;
                        
                        // ê´„í˜¸ê°€ ëª¨ë‘ ë‹«í˜€ìˆìœ¼ë©´ UPDATEì˜ FROM ì ˆ (ê´„í˜¸ ë°–)
                        if (openParens === closeParens) {
                            fromMatches.push({
                                pos: fromPos,
                                name: tableName
                            });
                        }
                    }
                }
                
                // ê°€ì¥ ë§ˆì§€ë§‰ FROMì´ UPDATEì˜ FROM ì ˆì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
                if (fromMatches.length > 0) {
                    var lastFrom = fromMatches[fromMatches.length - 1];
                    var tableName = lastFrom.name;
                    if (tableName && !isKeyword(tableName) && !isCTEName(tableName)) {
                        allTables.push({
                            type: 'update',
                            name: tableName
                        });
                    }
                }
            }
        }
        
        function extractDeleteTables(sqlText, sqlUpper) {
            // DELETE FROM í…Œì´ë¸”ëª… íŒ¨í„´ (OUTPUT ì œì™¸)
            var deletePattern = /DELETE\s+(?:FROM\s+)?([#]?[A-Za-z_][A-Za-z0-9_]*)/gi;
            var match;
            
            while ((match = deletePattern.exec(sqlText)) !== null) {
                var tableName = match[1].trim();
                // OUTPUT í‚¤ì›Œë“œ ì œì™¸
                if (tableName && !isKeyword(tableName) && tableName.toUpperCase() !== 'OUTPUT' && !isCTEName(tableName)) {
                    allTables.push({
                        type: 'delete',
                        name: tableName
                    });
                }
            }
            
            // MERGE ë¬¸ ë‚´ë¶€ì˜ DELETE ì°¾ê¸°
            // MERGE í…Œì´ë¸”ëª… ... WHEN NOT MATCHED BY SOURCE ... THEN DELETE
            var mergeRegex = /MERGE\s+(?:INTO\s+)?((?:\[?[A-Za-z_][A-Za-z0-9_]*\]?\.)?\[?#?[A-Za-z_][A-Za-z0-9_]*\]?)/gi;
            var mergeMatch;
            
            while ((mergeMatch = mergeRegex.exec(sqlText)) !== null) {
                var mergeStart = mergeMatch.index;
                var fullTableRef = mergeMatch[1].trim();
                // ìŠ¤í‚¤ë§ˆëª… ì œê±°í•˜ê³  í…Œì´ë¸”ëª…ë§Œ ì¶”ì¶œ
                var tableName = extractTableNameFromRef(fullTableRef);
                
                // MERGE ë¸”ë¡ì˜ ëì„ ì°¾ê¸°
                var blockEnd = sqlText.indexOf(';', mergeStart);
                if (blockEnd === -1) {
                    blockEnd = sqlText.length;
                }
                var mergeBlock = sqlText.substring(mergeStart, blockEnd);
                
                // WHEN NOT MATCHED BY SOURCE ... THEN DELETE íŒ¨í„´ ì°¾ê¸°
                var deleteInMergePattern = /WHEN\s+NOT\s+MATCHED\s+BY\s+SOURCE[\s\S]*?THEN\s+DELETE/gi;
                if (deleteInMergePattern.test(mergeBlock)) {
                    if (tableName && !isKeyword(tableName) && !isCTEName(tableName)) {
                        allTables.push({
                            type: 'delete',
                            name: tableName
                        });
                    }
                }
            }
        }
        
        function extractMergeTables(sqlText, sqlUpper) {
            // MERGE í…Œì´ë¸”ëª… íŒ¨í„´ (INTO í‚¤ì›Œë“œ ì§€ì›, ìŠ¤í‚¤ë§ˆëª… í¬í•¨ ì§€ì›)
            // MERGE INTO schema.table ë˜ëŠ” MERGE schema.table ë˜ëŠ” MERGE table
            var mergePattern = /MERGE\s+(?:INTO\s+)?((?:\[?[A-Za-z_][A-Za-z0-9_]*\]?\.)?\[?#?[A-Za-z_][A-Za-z0-9_]*\]?)/gi;
            var match;
            
            while ((match = mergePattern.exec(sqlText)) !== null) {
                var mergeStart = match.index;
                var fullTableRef = match[1].trim();
                // ìŠ¤í‚¤ë§ˆëª… ì œê±°í•˜ê³  í…Œì´ë¸”ëª…ë§Œ ì¶”ì¶œ
                var tableName = extractTableNameFromRef(fullTableRef);
                
                if (tableName && !isKeyword(tableName) && !isCTEName(tableName)) {
                    allTables.push({
                        type: 'merge',
                        name: tableName
                    });
                }
                
                // MERGE ë¸”ë¡ì˜ ëì„ ì°¾ê¸°
                var blockEnd = sqlText.indexOf(';', mergeStart);
                if (blockEnd === -1) {
                    blockEnd = sqlText.length;
                }
                var mergeBlock = sqlText.substring(mergeStart, blockEnd);
                
                // USING ì ˆ ë‚´ë¶€ì˜ ì„œë¸Œì¿¼ë¦¬ì—ì„œ í…Œì´ë¸” ì¶”ì¶œ
                // USING (SELECT ... FROM table) íŒ¨í„´
                var usingPattern = /USING\s*\(/gi;
                var usingMatch;
                while ((usingMatch = usingPattern.exec(mergeBlock)) !== null) {
                    var usingStart = usingMatch.index + usingMatch[0].length;
                    // USING ì ˆì˜ ê´„í˜¸ ë§¤ì¹­
                    var parenCount = 1;
                    var usingContent = '';
                    for (var i = usingStart; i < mergeBlock.length; i++) {
                        if (mergeBlock[i] === '(') {
                            parenCount++;
                        } else if (mergeBlock[i] === ')') {
                            parenCount--;
                            if (parenCount === 0) {
                                usingContent = mergeBlock.substring(usingStart, i);
                                break;
                            }
                        }
                    }
                    
                    // USING ì ˆ ë‚´ë¶€ì˜ ì„œë¸Œì¿¼ë¦¬ì—ì„œ í…Œì´ë¸” ì¶”ì¶œ
                    if (usingContent) {
                        extractTablesFromSubquery(usingContent);
                    }
                }
            }
        }
        
        function extractProcedureCalls(sqlText, sqlUpper) {
            // EXEC, EXECUTE, CALL íŒ¨í„´ ì°¾ê¸°
            // EXEC ProcedureName
            // EXEC dbo.ProcedureName
            // EXEC [dbo].[ProcedureName]
            // EXECUTE ProcedureName
            // CALL ProcedureName
            // CALL schema.ProcedureName
            var execPattern = /(?:EXEC|EXECUTE|CALL)\s+(?:\[?([A-Za-z_][A-Za-z0-9_]*)\]?\.)?\[?([A-Za-z_][A-Za-z0-9_]*)\]?/gi;
            var match;
            var seen = {};
            
            while ((match = execPattern.exec(sqlText)) !== null) {
                var procName = '';
                // match[2]ëŠ” í”„ë¡œì‹œì €ëª…, match[1]ì€ ìŠ¤í‚¤ë§ˆëª…
                if (match[2]) {
                    procName = match[2].trim();
                } else if (match[1]) {
                    // ìŠ¤í‚¤ë§ˆë§Œ ìˆê³  í”„ë¡œì‹œì €ëª…ì´ ì—†ëŠ” ê²½ìš° (ë“œë¬¼ì§€ë§Œ)
                    procName = match[1].trim();
                }
                
                if (procName && !isKeyword(procName) && !isCTEName(procName)) {
                    var key = 'exec|' + procName.toUpperCase();
                    if (!seen[key]) {
                        seen[key] = true;
                        allTables.push({
                            type: 'exec',
                            name: procName
                        });
                    }
                }
            }
        }
        
        function isKeyword(word) {
            var keywords = ['AS', 'ON', 'WHERE', 'SET', 'VALUES', 'INTO', 'FROM', 'JOIN', 'INNER', 'LEFT', 'RIGHT', 'FULL', 'OUTER', 
                            'UPDATE', 'DELETE', 'INSERT', 'SELECT', 'MERGE', 'WHEN', 'THEN', 'MATCHED', 'USING', 'TARGET', 'SOURCE',
                            'AND', 'OR', 'NOT', 'IN', 'EXISTS', 'IS', 'NULL', 'BY', 'GROUP', 'ORDER', 'HAVING', 'UNION', 'ALL'];
            return keywords.indexOf(word.toUpperCase()) !== -1;
        }
        
        function isCTEName(word) {
            return cteNames.indexOf(word.toUpperCase()) !== -1;
        }
        
        function removeDuplicates() {
            var seen = {};
            var unique = [];
            
            for (var i = 0; i < allTables.length; i++) {
                var key = allTables[i].type + '|' + allTables[i].name;
                if (!seen[key]) {
                    seen[key] = true;
                    unique.push(allTables[i]);
                }
            }
            
            allTables = unique;
        }
        
        function displayResults() {
            if (allTables.length === 0) {
                document.getElementById('resultSection').style.display = 'none';
                alert('í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í†µê³„ ê³„ì‚°
            var stats = {
                select: 0,
                insert: 0,
                update: 0,
                delete: 0,
                merge: 0,
                exec: 0,
                total: allTables.length
            };
            
            for (var i = 0; i < allTables.length; i++) {
                var type = allTables[i].type;
                if (stats[type] !== undefined) {
                    stats[type]++;
                }
            }
            
            // í†µê³„ í‘œì‹œ
            var statsHtml = '<div class="stat-item">' +
                '<div class="number">' + stats.total + '</div>' +
                '<div class="label">ì „ì²´</div>' +
                '</div>' +
                '<div class="stat-item">' +
                '<div class="number">' + stats.select + '</div>' +
                '<div class="label">SELECT</div>' +
                '</div>' +
                '<div class="stat-item">' +
                '<div class="number">' + stats.insert + '</div>' +
                '<div class="label">INSERT</div>' +
                '</div>' +
                '<div class="stat-item">' +
                '<div class="number">' + stats.update + '</div>' +
                '<div class="label">UPDATE</div>' +
                '</div>' +
                '<div class="stat-item">' +
                '<div class="number">' + stats.delete + '</div>' +
                '<div class="label">DELETE</div>' +
                '</div>' +
                '<div class="stat-item">' +
                '<div class="number">' + stats.merge + '</div>' +
                '<div class="label">MERGE</div>' +
                '</div>' +
                '<div class="stat-item">' +
                '<div class="number">' + stats.exec + '</div>' +
                '<div class="label">PROCEDURE</div>' +
                '</div>';
            
            document.getElementById('stats').innerHTML = statsHtml;
            
            // í…Œì´ë¸” ì •ë ¬ (íƒ€ì…ë³„, ì´ë¦„ë³„)
            allTables.sort(function(a, b) {
                if (a.type !== b.type) {
                    var order = {select: 1, insert: 2, update: 3, delete: 4, merge: 5};
                    return (order[a.type] || 99) - (order[b.type] || 99);
                }
                return a.name.localeCompare(b.name);
            });
            
            filteredTables = allTables;
            filterTable();
            
            document.getElementById('resultSection').style.display = 'block';
        }
        
        function filterTable() {
            var filterType = document.getElementById('typeFilter').value;
            
            if (filterType === 'all') {
                filteredTables = allTables;
            } else {
                filteredTables = [];
                for (var i = 0; i < allTables.length; i++) {
                    if (allTables[i].type === filterType) {
                        filteredTables.push(allTables[i]);
                    }
                }
            }
            
            renderTable();
        }
        
        function renderTable() {
            var container = document.getElementById('tableContainer');
            
            if (filteredTables.length === 0) {
                container.innerHTML = '<div class="no-results">ì„ íƒí•œ íƒ€ì…ì˜ í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            var html = '<table><thead><tr>' +
                '<th style="width: 80px; text-align: center;">No</th>' +
                '<th style="width: 150px;">Type <input type="checkbox" id="checkType" style="margin-left: 5px;"></th>' +
                '<th>Table Name <input type="checkbox" id="checkTableName" style="margin-left: 5px;"></th>' +
                '</tr></thead><tbody>';
            
            for (var i = 0; i < filteredTables.length; i++) {
                var item = filteredTables[i];
                var typeClass = 'type-' + item.type;
                var typeDisplay = item.type.toUpperCase();
                // EXEC íƒ€ì…ì„ PROCEDUREë¡œ í‘œì‹œ
                if (item.type === 'exec') {
                    typeDisplay = 'PROCEDURE';
                }
                html += '<tr>' +
                    '<td style="text-align: center; color: #666;">' + (i + 1) + '</td>' +
                    '<td><span class="type-badge ' + typeClass + '">' + typeDisplay + '</span></td>' +
                    '<td><span class="table-name">' + escapeHtml(item.name) + '</span></td>' +
                    '</tr>';
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function copySelectedColumns() {
            var checkType = document.getElementById('checkType');
            var checkTableName = document.getElementById('checkTableName');
            
            if (!checkType || !checkTableName) {
                alert('ê·¸ë¦¬ë“œë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            var typeChecked = checkType.checked;
            var nameChecked = checkTableName.checked;
            
            if (!typeChecked && !nameChecked) {
                alert('ë³µì‚¬í•  ì»¬ëŸ¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            var copyText = '';
            
            // í—¤ë” ìƒì„±
            if (typeChecked && nameChecked) {
                copyText = 'type   |  name\n';
            } else if (typeChecked) {
                copyText = 'type\n';
            } else if (nameChecked) {
                copyText = 'name\n';
            }
            
            // ë°ì´í„° ë³µì‚¬
            for (var i = 0; i < filteredTables.length; i++) {
                var item = filteredTables[i];
                if (typeChecked && nameChecked) {
                    copyText += item.type + '  |  ' + item.name + '\n';
                } else if (typeChecked) {
                    copyText += item.type + '\n';
                } else if (nameChecked) {
                    copyText += item.name + '\n';
                }
            }
            
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            var textarea = document.createElement('textarea');
            textarea.value = copyText;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                alert('ì„ íƒí•œ ì»¬ëŸ¼ ë°ì´í„°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (err) {
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.\n\n' + copyText);
            }
            
            document.body.removeChild(textarea);
        }
        
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        function clearAll() {
            document.getElementById('sqlInput').value = '';
            document.getElementById('resultSection').style.display = 'none';
            allTables = [];
            filteredTables = [];
        }
    </script>
</body>
</html>

